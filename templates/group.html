<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>×”×›×•×œ ×¢×œ×™×™ â€“ {{ group }}</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    body {
      font-family: 'Arimo', sans-serif;
      direction: rtl;
      margin: 0;
      padding: 1rem;
    }
    @media (min-width: 768px) {
      body { padding: 0.5rem 2rem; }
    }
    @media (min-width: 1024px) {
      body { padding: 0.5rem 4rem; }
    }
    h1 { font-size: 1.4rem; color: #1287a4; margin-bottom: 0.5rem; }
    #header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    #link-box {
      background-color: #f5f5f5;
      padding: 0.5em 1em;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.5em;
      max-width: 350px;
    }
    #group-link { width: 100%; max-width: 240px; padding: 0.3em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; font-size: 0.95rem; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    .available { background-color: #e6f7ff; }
    .completed { background-color: #d4edda; color: #155724; }
    input, button {
      font-size: 1rem;
      padding: 0.4em 0.6em;
      margin: 0.2em;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
    }
    button {
      background-color: #1287a4;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background-color: #0f6e8a; }
    form { margin-top: 1em; margin-bottom: 1em; }
    .quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }
    .quantity-control form button,
    .quantity-control span {
      width: 32px;
      height: 32px;
      font-size: 1rem;
      padding: 0;
      text-align: center;
      line-height: 32px;
    }
    .note-textarea textarea {
      width: 100%;
      min-height: 2.5em;
      max-height: 6em;
      resize: vertical;
    }
    .actions-inline {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
      justify-content: center;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.1rem; }
      table, thead, tbody, th, td, tr { display: block; }
      tr {
        margin-bottom: 1.5em;
        border: 1px solid #ccc;
        padding: 0.8em;
        border-radius: 10px;
        background: #f9f9f9;
      }
      td {
        text-align: right;
        padding: 0.4em 0;
      }
      td::before {
        content: attr(data-label);
        font-weight: bold;
        display: inline-block;
        width: 6.5em;
        color: #333;
      }
      th { display: none; }
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>×”×›×•×œ ×¢×œ×™×™ â€“ ×§×‘×•×¦×”: {{ group }}</h1>
    {% if is_new %}
      <div id="link-box">
        <input type="text" id="group-link" readonly value="{{ request.url }}">
        <button onclick="copyLink()">×”×¢×ª×™×§×™</button>
      </div>
      <p style="margin: 0; font-size: 0.9rem; color: #555;">×©××¨×™ ××ª ×”×§×™×©×•×¨ â€“ ×œ× × ×™×ª×Ÿ ×œ×—×–×•×¨ ××œ×™×• ×× ×”×•× ×œ× × ×©××¨ ğŸ’¡</p>
    {% endif %}
  </div>

  <form action="/group/{{ group }}/add_task" method="POST">
    <input type="text" name="task" placeholder="××” ×”××©×™××”?" required>
    <input type="number" name="amount" placeholder="×›××” ×œ×”×‘×™×?" min="0">
    <input type="text" name="note" placeholder="×”×¢×¨×•×ª (××™×“×•×ª, ××œ×¨×’×™×•×ª...)">
    <input type="text" name="name" placeholder="××™ ××¦×™×¢×” ××ª ×–×”? (×œ× ×—×•×‘×”)">
    <input type="text" name="child" placeholder="×©× ×”×™×œ×“/×” (×œ× ×—×•×‘×”)">
    <input type="date" name="deadline" placeholder="×ª××¨×™×š ×™×¢×“">
    <button type="submit"><span style="color: white;">â•</span> ×”×•×¡×¤×”</button>
  </form>

  <table>
    <tr>
      <th>××©×™××”</th>
      <th>×›××•×ª</th>
      <th>×”×¢×¨×•×ª</th>
      <th>×ª××¨×™×š ×™×¢×“</th>
      <th>××™ ×œ×•×§×—×ª</th>
      <th>×¤×¢×•×œ×”</th>
    </tr>
    {% for task in tasks %}
      <tr class="{% if task.completed %}completed{% elif not task.assigned_to %}available{% endif %}">
        <td data-label="××©×™××”">
          {% if task.completed %}âœ… {{ task.task }}<br><small>×›×œ ×”×›×‘×•×“!</small>{% else %}{{ task.task }}{% endif %}
        </td>
        <td data-label="×›××•×ª">
          <div class="quantity-control">
            <form method="POST" action="/group/{{ group }}/update_amount/{{ loop.index0 }}">
              <input type="hidden" name="change" value="-1">
              <button type="submit">-</button>
            </form>
            <span>{{ task.amount or '0' }}</span>
            <form method="POST" action="/group/{{ group }}/update_amount/{{ loop.index0 }}">
              <input type="hidden" name="change" value="1">
              <button type="submit">+</button>
            </form>
          </div>
        </td>
        <td data-label="×”×¢×¨×•×ª">
          {% if not task.completed %}
            {% if not task.editing_note %}
              <div>{{ task.note or '-' }}</div>
              <form method="POST" action="/group/{{ group }}/edit_note/{{ loop.index0 }}">
                <button type="submit">×¢×¨×›×™</button>
              </form>
            {% else %}
              <form method="POST" class="note-textarea" action="/group/{{ group }}/update_note/{{ loop.index0 }}">
                <textarea name="note">{{ task.note or '' }}</textarea>
                <button type="submit">×©××¨×™</button>
              </form>
            {% endif %}
          {% else %}{{ task.note or '-' }}{% endif %}
        </td>
        <td data-label="×ª××¨×™×š ×™×¢×“">
          {% if not task.completed %}
            <form method="POST" action="/group/{{ group }}/update_deadline/{{ loop.index0 }}">
              <input type="date" name="deadline" value="{{ task.deadline or '' }}" onchange="this.form.submit()">
            </form>
          {% else %}{{ task.deadline or '-' }}{% endif %}
        </td>
        <td data-label="××™ ×œ×•×§×—×ª">
          {{ task.assigned_to or '×¤× ×•×™' }}
          {% if task.child_name %}<br><small>({{ task.child_name }})</small>{% endif %}
        </td>
        <td data-label="×¤×¢×•×œ×”">
          <div class="actions-inline">
            {% if not task.completed %}
              {% if not task.assigned_to %}
                <form action="/group/{{ group }}/take_task/{{ loop.index0 }}" method="POST">
                  <input type="text" name="name" placeholder="×©××š" required>
                  <input type="text" name="child" placeholder="×©× ×”×™×œ×“/×” (×œ× ×—×•×‘×”)">
                  <button type="submit">×× ×™ ××§×—</button>
                </form>
              {% else %}
                <form action="/group/{{ group }}/release_task/{{ loop.index0 }}" method="POST">
                  <button type="submit">×©×—×¨×¨×™</button>
                </form>
                <form action="/group/{{ group }}/complete_task/{{ loop.index0 }}" method="POST">
                  <button type="submit">×¡×™×™××ª×™</button>
                </form>
              {% endif %}
              <form action="/group/{{ group }}/delete_task/{{ loop.index0 }}" method="POST" onsubmit="return confirm('×”×× ××ª ×‘×˜×•×—×” ×©×ª×¨×¦×™ ×œ××—×•×§ ××ª ×”××©×™××” ×”×–×•?')">
                <button type="submit" style="background-color: #ccc; color: #222;">××—×§×™</button>
              </form>
            {% else %}âœ”ï¸ ×‘×•×¦×¢{% endif %}
          </div>
        </td>
      </tr>
    {% endfor %}
  </table>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('new') === '1') {
      localStorage.setItem('hakol_alai_last_group', window.location.href);
    }
    function copyLink() {
      const input = document.getElementById("group-link");
      input.select();
      input.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("×”×§×™×©×•×¨ ×”×•×¢×ª×§ ğŸ’«");
    }
  </script>
</body>
</html>
